name: Multi-Session AI IDE CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Matrix build –¥–ª—è –≤—Å–µ—Ö AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
  build-matrix:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # GLM-4.6 (–¥–æ 5 —Å–µ—Å—Å–∏–π)
          - provider: glm
            image-name: glm-ide
            dockerfile: containers/glm-ide/Dockerfile
            max-sessions: 5
            memory-limit: 3g
            cpu-limit: 1.5
            
          # Gemini (–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏)
          - provider: gemini
            image-name: gemini-ide
            dockerfile: containers/gemini-ide/Dockerfile
            max-sessions: unlimited
            memory-limit: 2g
            cpu-limit: 1.0
            
          # Claude (–Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏)
          - provider: claude
            image-name: claude-ide
            dockerfile: containers/claude-ide/Dockerfile
            max-sessions: unlimited
            memory-limit: 2g
            cpu-limit: 1.0
    
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Container Registry
      if: github.event_name != 'pull_request'
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/${{ matrix.provider }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=semver,pattern={{major}}
          type=sha,prefix={{branch}}-
        labels: |
          ai.provider=${{ matrix.provider }}
          ai.max-sessions=${{ matrix.max-sessions }}
          ai.memory-limit=${{ matrix.memory-limit }}
          ai.cpu-limit=${{ matrix.cpu-limit }}
    
    - name: Build and test ${{ matrix.provider }} image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.dockerfile }}
        push: false
        load: true
        tags: test-${{ matrix.provider }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          PROVIDER=${{ matrix.provider }}
          MAX_SESSIONS=${{ matrix.max-sessions }}
    
    - name: Test ${{ matrix.provider }} container functionality
      run: |
        echo "üîç Testing ${{ matrix.provider }} container..."
        
        # –ë–∞–∑–æ–≤—ã–π —Ç–µ—Å—Ç –∑–∞–ø—É—Å–∫–∞
        docker run --rm test-${{ matrix.provider }}:latest --version || echo "Version check (expected for test)"
        
        # –¢–µ—Å—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —É—Ç–∏–ª–∏—Ç
        docker run --rm --entrypoint="" test-${{ matrix.provider }}:latest which node
        docker run --rm --entrypoint="" test-${{ matrix.provider }}:latest which git
        docker run --rm --entrypoint="" test-${{ matrix.provider }}:latest which ssh
        
        # –¢–µ—Å—Ç Node.js
        docker run --rm --entrypoint="" test-${{ matrix.provider }}:latest node --version
        
        # –¢–µ—Å—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö –¥–ª—è –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ —Ñ—É–Ω–∫—Ü–∏–π
        case "${{ matrix.provider }}" in
          glm)
            echo "ü§ñ Testing GLM-4.6 specific features..."
            docker run --rm --entrypoint="" test-${{ matrix.provider }}:latest test -f /root/.claude/settings.json
            ;;
          gemini)
            echo "üöÄ Testing Gemini specific features..."
            docker run --rm --entrypoint="" test-${{ matrix.provider }}:latest test -f /root/.config/gcloud
            ;;
          claude)
            echo "üîß Testing Claude specific features..."
            docker run --rm --entrypoint="" test-${{ matrix.provider }}:latest test -f /root/.claude
            ;;
        esac
        
        echo "‚úÖ ${{ matrix.provider }} container tests passed"
    
    - name: Build and push ${{ matrix.provider }} image
      if: github.event_name != 'pull_request'
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ${{ matrix.dockerfile }}
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          PROVIDER=${{ matrix.provider }}
          MAX_SESSIONS=${{ matrix.max-sessions }}

  # Session Manager —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
  test-session-manager:
    runs-on: ubuntu-latest
    needs: build-matrix
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Test session manager scripts
      run: |
        echo "üîç Testing session manager..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å–∞
        bash -n session-manager/session-manager.sh
        
        # –¢–µ—Å—Ç help —Ñ—É–Ω–∫—Ü–∏–∏
        bash session-manager/session-manager.sh help
        
        # –¢–µ—Å—Ç health –ø—Ä–æ–≤–µ—Ä–∫–∏
        bash session-manager/session-manager.sh health
        
        echo "‚úÖ Session manager tests passed"

  # Multi-session integration —Ç–µ—Å—Ç—ã
  test-multi-session:
    runs-on: ubuntu-latest
    needs: [build-matrix, test-session-manager]
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Test multi-session orchestration
      run: |
        echo "üîç Testing multi-session orchestration..."
        
        # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker Compose
        sudo apt-get update
        sudo apt-get install -y docker-compose-plugin
        
        # –¢–µ—Å—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        docker-compose -f orchestrator/docker-compose.multi.yml config
        
        # –¢–µ—Å—Ç –∑–∞–ø—É—Å–∫–∞ session manager (–≤ simulation —Ä–µ–∂–∏–º–µ)
        docker-compose -f orchestrator/docker-compose.multi.yml --profile templates config
        
        echo "‚úÖ Multi-session orchestration tests passed"

  # Security —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
  security-scan:
    runs-on: ubuntu-latest
    needs: build-matrix
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/glm:latest
        format: 'sarif'
        output: 'trivy-glm-results.sarif'
    
    - name: Upload GLM Trivy scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-glm-results.sarif'
        category: glm-container-scan

  # Performance —Ç–µ—Å—Ç—ã
  performance-test:
    runs-on: ubuntu-latest
    needs: build-matrix
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Test GLM multi-session performance
      run: |
        echo "üîç Testing GLM-4.6 multi-session performance..."
        
        # –ó–∞–ø—É—Å–∫ 5 GLM —Å–µ—Å—Å–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
        for i in {1..5}; do
          echo "Starting GLM session $i..."
          timeout 30s docker run --rm -d \
            --name glm-test-$i \
            -e ZAI_API_KEY=test \
            -e SESSION_ID=test-$i \
            ghcr.io/${{ github.repository }}/glm:latest &
        done
        
        wait
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤
        docker stats --no-stream glm-test-*
        
        # –û—á–∏—Å—Ç–∫–∞
        docker stop glm-test-* 2>/dev/null || true
        docker rm glm-test-* 2>/dev/null || true
        
        echo "‚úÖ GLM multi-session performance test passed"

  # Release –ø—É–±–ª–∏–∫–∞—Ü–∏—è
  release:
    needs: [build-matrix, test-session-manager, test-multi-session, security-scan, performance-test]
    runs-on: ubuntu-latest
    if: github.event_name == 'release'
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Generate release notes
      uses: softprops/action-gh-release@v1
      with:
        generate_release_notes: true
        files: |
          unified-interface/ai-ide-multi.zsh
          session-manager/session-manager.sh
          orchestrator/docker-compose.multi.yml
          README.md
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Update Docker Hub descriptions
      run: |
        echo "üìù Updating repository description..."
        # –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø–∏—Å–∞–Ω–∏–π –≤ registry
        echo "Release published successfully"

  # Documentation —Ç–µ—Å—Ç—ã
  docs-test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Test documentation
      run: |
        echo "üìö Testing documentation..."
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ README.md
        if [[ -f "README.md" ]]; then
          echo "‚úÖ README.md exists"
        else
          echo "‚ùå README.md missing"
          exit 1
        fi
        
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–µ–∫—Ü–∏–π
        if grep -q "Multi-Session AI IDE" README.md && \
           grep -q "GLM-4.6" README.md && \
           grep -q "Quick Start" README.md; then
          echo "‚úÖ README.md contains required sections"
        else
          echo "‚ùå README.md missing required sections"
          exit 1
        fi
        
        echo "‚úÖ Documentation validation passed"
